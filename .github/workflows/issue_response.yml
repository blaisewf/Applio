name: Issue Response

on:
  issues:
    types: [opened, edited]

jobs:
  auto_reply:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Response and Post Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const repo = context.repo.repo;
            const issueNumber = issue.number;
            const issueBody = issue.body;

            const systemPrompt = `Provide a helpful response based on the repository and issue description: ${issueBody}`;

            const groqApiKey = process.env.GROQ_API_KEY;

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${groqApiKey}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                messages: [
                  { role: 'system', content: systemPrompt },
                  { role: 'user', content: issueBody },
                ],
                model: 'llama3-8b-8192',
              }),
            });

            if (!response.ok) {
              throw new Error('Failed to fetch response from LLM');
            }

            const data = await response.json();
            const llmResponse = data.choices[0].message.content;

            const commentMessage = `Thank you for your issue. Here is some information that might help:\n\n${llmResponse}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: repo,
              issue_number: issueNumber,
              body: commentMessage,
            });
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
